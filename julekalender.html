<html>
<title>Julekalender</title>
<style>
.button {
  background-color: #f44336;
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
}
</style>

<body>

    <button id="spin" class="button">Spin</button>
    <div>
        <canvas id="canvas" width="500" height="500"></canvas>
    </div>

    <script type="text/javascript">
        var colors = ["#eaeaea", "#cccccc", "#eaeaea", "#cccccc",
            "#eaeaea", "#cccccc", "#eaeaea", "#cccccc", "#eaeaea", "#cccccc", "#eaeaea", "#cccccc", "#eaeaea", "#cccccc", "#eaeaea", "#cccccc", "#eaeaea", "#cccccc", "#eaeaea", "#cccccc", "#eaeaea", "#cccccc"];
        // NEED to pre load this data prior
        var prize_descriptions = durstenfeldShuffle(["Joakim", "Torbj√∏rn", "Kjetil", "Tomas",
            "Einar", "Marianne", "Lina", "Tommy", "Jan Egil", "Nicolai", "Iselin", "Tim", "Morten", "Inese", "Pavels","Paul", "Petter", "Rune"]);


        var current_user_status = {};

        var startAngle = 0;
        var arc = Math.PI / (prize_descriptions.length / 2);
        var spinTimeout = null;

        var spinArcStart = 10;
        var spinTime = 0;
        var spinTimeTotal = 0;

        var current_user_status = null;
        var spin_results = null;

        var ctx;

        function drawSpinnerWheel() {
            var canvas = document.getElementById("canvas");
                    if (canvas.getContext) {
                        var outsideRadius = 200;
                        var textRadius = 160;
                        var insideRadius = 125;

                        ctx = canvas.getContext("2d");
                        ctx.clearRect(0, 0, 800, 800);


                        ctx.strokeStyle = "black";
                        ctx.lineWidth = 2;

                        ctx.font = 'bold 12px Helvetica, Arial';

                        for (var i = 0; i < prize_descriptions.length; i++) {
                            var angle = startAngle + i * arc;
                            ctx.fillStyle = colors[i];

                            ctx.beginPath();
                            ctx.arc(250, 250, outsideRadius, angle, angle + arc, false);
                            ctx.arc(250, 250, insideRadius, angle + arc, angle, true);
                            ctx.stroke();
                            ctx.fill();

                            ctx.save();
                            ctx.shadowOffsetX = -1;
                            ctx.shadowOffsetY = -1;
                            ctx.shadowBlur = 0;
                            ctx.shadowColor = "rgb(220,220,220)";
                            ctx.fillStyle = "black";
                            ctx.translate(250 + Math.cos(angle + arc / 2) * textRadius, 250 + Math.sin(angle + arc / 2) * textRadius);
                            ctx.rotate(angle + arc / 2 + Math.PI / 2);
                            var text = prize_descriptions[i];
                            if (text === undefined) text = "Try again!";
                            ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
                            ctx.restore();
                        }

                //Arrow
                ctx.fillStyle = "black";
                ctx.beginPath();
                ctx.moveTo(250 - 4, 250 - (outsideRadius + 5));
                ctx.lineTo(250 + 4, 250 - (outsideRadius + 5));
                ctx.lineTo(250 + 4, 250 - (outsideRadius - 5));
                ctx.lineTo(250 + 9, 250 - (outsideRadius - 5));
                ctx.lineTo(250 + 0, 250 - (outsideRadius - 13));
                ctx.lineTo(250 - 9, 250 - (outsideRadius - 5));
                ctx.lineTo(250 - 4, 250 - (outsideRadius - 5));
                ctx.lineTo(250 - 4, 250 - (outsideRadius + 5));
                ctx.fill();
            }
        }

        function spin() {
            spinAngleStart = 1 * 10 + 10;
            spinTime = 0;
            var array = new Uint32Array(1);
            var rand = window.crypto.getRandomValues(array)[0] / 0x100000000;

            spinTimeTotal = 4000 + (3000 * rand);
            rotateWheel();
        }


        function durstenfeldShuffle(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var rand = window.crypto.getRandomValues(new Uint32Array(1))[0] / 0x100000000;
                var j = Math.floor(rand * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        }

        function rotateWheel() {
            var array = new Uint32Array(1);
            var rand = window.crypto.getRandomValues(array)[0] / 0x100000000;
            console.log(rand);

            spinTime += 20 * rand;
            if (spinTime >= spinTimeTotal) {
                stopRotateWheel();
                return;
            }
            var spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
            startAngle += (spinAngle * Math.PI / 180);
            drawSpinnerWheel();
            spinTimeout = setTimeout('rotateWheel()', 30);
        }

        function stopRotateWheel() {
            clearTimeout(spinTimeout);
            var degrees = startAngle * 180 / Math.PI + 90;
            var arcd = arc * 180 / Math.PI;
            var index = Math.floor((360 - degrees % 360) / arcd);
            ctx.save();
            ctx.font = 'bold 30px Helvetica, Arial';
            var text = prize_descriptions[index];
            if (text === undefined) text = "Try again!";
            ctx.fillText(text, 250 - ctx.measureText(text).width / 2, 250 + 10);
            ctx.restore();
        }

        function easeOut(t, b, c, d) {
            var ts = (t /= d) * t;
            var tc = ts * t;
            return b + c * (tc + -3 * ts + 3 * t);
        }

        drawSpinnerWheel();

        document.getElementById("spin").onclick = function (e) {
            e.preventDefault();
            spin();
        };
    </script>

</body>

</html>
